"use strict";var _createClass=function(){function a(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&void 0!==module?module.exports=t():"function"==typeof define&&define.amd?define(t()):e.EmiyaCanvas=t()}(window,function(){var o={width:window.screen.width,height:window.screen.height,quality:.8},n=window.EXIF;return function(){function e(){_classCallCheck(this,e),this.el={img:new Image},this._data={},Object.defineProperty(this,"_data",{enumerable:!1})}return _createClass(e,[{key:"setFile",value:function(e){this._data.file=e}},{key:"setBase64",value:function(e){this._data.base64=e}},{key:"render",value:function(e,t,i){var a=this.getHTMLElement(e),n=this._data.file||this._data.base64;if(this.el.canvas=a,this.renderCallback=i,!n)throw new Error("请先调用 setFile api 设置文件对象, 或调用 setBase64 api 设置文件流");this.extend(this._data,t,o),this._handleFile(n)}},{key:"_handleFile",value:function(t){var i=this.el.img,a=this;"object"===(void 0===t?"undefined":_typeof(t))?this.blobToBase64(t).then(function(e){i.src=e,a._data.base64=e,i.onload=function(){n.getData(t,function(){n.getAllTags(this),a._drawImage(e,n.getTag(this,"Orientation"))})}}):"string"==typeof t&&(i.src=t,i.onload=function(){n.getData(i,function(){n.getAllTags(this),a._drawImage(t,n.getTag(this,"Orientation"))})})}},{key:"_drawImage",value:function(e,t){var i=this._data,a=this.el.canvas,n=a.getContext("2d"),o=this.getImgMIME(e),r=this.renderCallback,h=this.getPixelRatio(n);h=h?h+window.devicePixelRatio:0;var s=this._getResize(i),l=this._handleOrientation(s,t),d=l.canvasWidth,c=l.canvasHeight,u=l.drawWidth*h,g=l.drawHeight*h,f=d*h,w=c*h,y=l.degree;a.width=f,a.height=w,a.style.width=d+"px",a.style.height=c+"px",n.rotate(y*Math.PI/180),n.drawImage(this.el.img,0,0,u,g),r&&"function"==typeof r&&r.call(this,{base64:a.toDataURL(o,this._data.quality),width:d,height:c})}},{key:"getCanvasOptions",value:function(e){this.getCanvasOptionsCallback=e}},{key:"_getResize",value:function(e){var t=this.el.img,i=parseInt(e.width,10),a=parseInt(e.height,10),n=this.orientation,o=t.width,r=t.height,h={width:o,height:r};if("5678".includes(n)&&(h.width=o,h.height=r),h.width<i||h.height<a)return h;var s=h.width/h.height;for(i&&a?i/a<=s?h.width>i&&(h.width=i,h.height=Math.ceil(i/s)):h.height>a&&(h.height=a,h.width=Math.ceil(a*s)):i?i<h.width&&(h.width=i,h.height=Math.ceil(i/s)):a&&a<h.height&&(h.width=Math.ceil(a*s),h.height=a);3264<=h.width||2448<=h.height;)h.width*=.8,h.height*=.8;return h}},{key:"_handleOrientation",value:function(e,t){var i=e.width,a=e.height,n=i,o=a,r=i,h=a,s=0;switch(t){case 3:s=180,n=-i,o=-a;break;case 6:s=90,h=i,o=-(r=a);break;case 8:s=270,n=-(h=i),o=r=a}return{degree:s,canvasWidth:r,canvasHeight:h,drawWidth:n,drawHeight:o}}},{key:"getPixelRatio",value:function(e){var t=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/t}},{key:"blobToBase64",value:function(e){var i=new FileReader;return i.readAsDataURL(e),new Promise(function(t,e){i.onload=function(e){t(e.target.result)}})}},{key:"getHTMLElement",value:function(e){return"string"==typeof e&&1!==e.nodeType?document.querySelector(e):e}},{key:"getImgMIME",value:function(e){return e.match(/data:(.*);/)[1]}},{key:"extend",value:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var a=t[0],n=1,o=t.length;n<o;n++){var r=t[n];for(var h in r)void 0===a[h]&&(a[h]=r[h])}}}]),e}()});